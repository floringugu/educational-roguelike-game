<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Anki Deck - Educational Roguelike</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pixel-style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">üì§ UPLOAD ANKI DECK</h1>
            <p class="page-subtitle">Import Your Flashcards</p>
        </div>

        <div class="btn-group mb-xl">
            <a href="/" class="btn">‚Üê Back to Home</a>
        </div>

        <!-- Upload Form -->
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <div class="card-title">üÉè Upload Anki CSV File</div>
            <div class="card-content">
                <form id="upload-form" enctype="multipart/form-data" style="text-align: center;">
                    <div class="mb-lg">
                        <input
                            type="file"
                            id="csv-file"
                            name="file"
                            accept=".csv"
                            required
                            style="display: none;">
                        <label for="csv-file" class="btn btn-primary" style="cursor: pointer;">
                            üìÅ Choose CSV File
                        </label>
                        <div id="file-name" class="mt-md text-accent" style="font-size: 10px;"></div>
                    </div>

                    <div id="upload-info" class="mb-lg" style="font-size: 9px; line-height: 2; text-align: left;">
                        <p class="text-primary">‚ÑπÔ∏è Upload Instructions:</p>
                        <ul style="list-style: none; padding-left: 20px;">
                            <li>‚úì Maximum file size: 10 MB</li>
                            <li>‚úì Only CSV files accepted</li>
                            <li>‚úì Export from Anki in CSV format</li>
                            <li>‚úì Format: Front,Back or Front,Back,Tags</li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-primary" id="upload-btn">
                        üöÄ Upload Deck
                    </button>
                </form>

                <div id="progress-container" class="hidden mt-lg">
                    <div class="progress-bar-container">
                        <div class="progress-label" id="progress-label">Processing...</div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="upload-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="upload-result" class="mt-lg"></div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card mt-xl" style="max-width: 600px; margin: var(--spacing-xl) auto 0;">
            <div class="card-title">üìñ How to Export from Anki</div>
            <div class="card-content" style="font-size: 10px; line-height: 2;">
                <p class="mb-md"><strong>Steps to export your Anki deck:</strong></p>
                <ol style="padding-left: 30px; line-height: 2;">
                    <li>Open Anki and select your deck</li>
                    <li>Click <strong>File ‚Üí Export</strong></li>
                    <li>Choose <strong>"Notes in Plain Text"</strong></li>
                    <li>Select <strong>".csv" format</strong></li>
                    <li>Include <strong>fields</strong> and optionally <strong>tags</strong></li>
                    <li>Save the file</li>
                    <li>Upload it here!</li>
                </ol>

                <p class="text-accent mt-md">
                    <strong>Supported formats:</strong><br>
                    ‚Ä¢ <code>Front,Back</code><br>
                    ‚Ä¢ <code>Front,Back,Tags</code><br>
                    ‚Ä¢ <code>Front,Back,Tags,NoteType</code>
                </p>

                <p class="mt-md">
                    <strong>Example CSV content:</strong><br>
                    <code style="font-size: 8px; background: #0a0a0a; padding: 4px; display: block; margin-top: 8px;">
                    ¬øQu√© es Python?,Un lenguaje de programaci√≥n,programaci√≥n<br>
                    ¬øCapital de Francia?,Par√≠s,geograf√≠a europa<br>
                    Traduce: Hello,Hola,ingl√©s vocabulario
                    </code>
                </p>
            </div>
        </div>
    </div>

    <div id="loading-indicator" class="hidden notification info">Loading...</div>

    <script>
        const fileInput = document.getElementById('csv-file');
        const fileName = document.getElementById('file-name');
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('upload-btn');
        const progressContainer = document.getElementById('progress-container');
        const uploadResult = document.getElementById('upload-result');

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = `Selected: ${e.target.files[0].name}`;
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file (.csv extension)');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';
            progressContainer.classList.remove('hidden');
            uploadResult.innerHTML = '';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                // Success - redirect to home after showing message
                uploadResult.innerHTML = `
                    <div class="card" style="border-color: var(--color-hp-high);">
                        <div class="card-title text-primary">‚úÖ Import Successful!</div>
                        <div class="card-content" style="font-size: 10px;">
                            <p><strong>Deck Name:</strong> ${data.deck_name}</p>
                            <p><strong>Cards Imported:</strong> ${data.cards_imported}</p>
                            <p><strong>Unique Tags:</strong> ${data.total_tags}</p>
                            <p class="mt-md text-accent">${data.message}</p>
                            <div class="btn-group mt-md">
                                <a href="/game/${data.deck_id}" class="btn btn-primary">
                                    ‚öîÔ∏è Play Now
                                </a>
                                <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Upload error:', error);
                uploadResult.innerHTML = `
                    <div class="card" style="border-color: var(--color-danger);">
                        <div class="card-title text-danger">‚ùå Upload Failed</div>
                        <div class="card-content" style="font-size: 10px;">
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p class="mt-md">Please check:</p>
                            <ul style="padding-left: 20px;">
                                <li>File is a valid CSV</li>
                                <li>Format is: Front,Back or Front,Back,Tags</li>
                                <li>File is not empty</li>
                                <li>File size is under 10MB</li>
                            </ul>
                        </div>
                    </div>
                `;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Upload Deck';
            } finally {
                progressContainer.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
